<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marketplace - Plataforma AgrÃ­cola</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .marketplace-header {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
            padding: 40px 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
        }

        .marketplace-header h1 {
            margin: 0;
            font-size: 2.5em;
        }

        .marketplace-header p {
            margin: 10px 0 0;
            opacity: 0.9;
            font-size: 1.1em;
        }

        .cart-badge {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #e74c3c;
            color: white;
            padding: 15px 25px;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
            cursor: pointer;
            font-weight: bold;
            z-index: 1000;
            transition: transform 0.3s;
        }

        .cart-badge:hover {
            transform: scale(1.1);
        }

        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
        }

        .product-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .product-image {
            height: 200px;
            background-color: #f0f2f5;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3em;
            color: #bdc3c7;
            overflow: hidden;
        }

        .product-details {
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .product-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .product-price {
            font-size: 1.4em;
            color: #2ecc71;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .product-meta {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-bottom: 20px;
            flex: 1;
        }

        .quantity-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .quantity-selector button {
            width: 35px;
            height: 35px;
            border: 2px solid #2ecc71;
            background: white;
            color: #2ecc71;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quantity-selector button:hover {
            background: #2ecc71;
            color: white;
        }

        .quantity-selector input {
            width: 60px;
            text-align: center;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }

        .add-to-cart-btn {
            background: #2ecc71;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            width: 100%;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
            text-align: center;
        }

        .add-to-cart-btn:hover {
            background: #27ae60;
        }

        .search-bar {
            margin-bottom: 30px;
            display: flex;
            gap: 10px;
        }

        .search-input {
            flex: 1;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
        }

        .filter-btn {
            padding: 15px 25px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            color: #666;
        }

        /* Modal del Carrito */
        .cart-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .cart-modal.show {
            display: flex;
        }

        .cart-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .cart-item {
            display: flex;
            gap: 15px;
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            align-items: center;
        }

        .cart-item-image {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
        }

        .cart-item-details {
            flex: 1;
        }

        .cart-item-remove {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
        }

        .cart-total {
            font-size: 1.5em;
            font-weight: bold;
            color: #2ecc71;
            text-align: right;
            margin-top: 20px;
        }

        .checkout-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
        }

        .checkout-btn:hover {
            opacity: 0.9;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="nav">
            <a href="/dashboard/comprador">â¬… Volver al Dashboard</a>
            <div style="flex: 1;"></div>
            <span>ðŸ›’ Marketplace</span>
        </div>

        <!-- Badge del Carrito -->
        <div class="cart-badge" onclick="toggleCart()">
            ðŸ›’ Carrito (<span id="cart-count">0</span>)
        </div>

        <div class="marketplace-header">
            <h1>Productos Frescos Directo del Campo</h1>
            <p>Conecta con productores verificados y adquiere productos de calidad.</p>
        </div>

        <div class="search-bar">
            <input type="text" class="search-input" placeholder="Â¿QuÃ© estÃ¡s buscando hoy? (Ej: MaÃ­z, Trigo, CafÃ©...)">
            <button class="filter-btn">Filtrar</button>
        </div>

        <div class="product-grid">
            {% for producto in productos %}
            <div class="product-card">
                <div class="product-image">
                    {% if producto.imagenUrl %}
                    <img src="{{ producto.imagenUrl }}" alt="{{ producto.nombre }}"
                        style="width: 100%; height: 100%; object-fit: cover;">
                    {% else %}
                    ðŸŒ±
                    {% endif %}
                </div>
                <div class="product-details">
                    <div class="product-title">{{ producto.nombre }}</div>
                    <div class="product-price">${{ producto.precio }} / kg</div>
                    <div class="product-meta">
                        <p style="margin: 5px 0; line-height: 1.4;">{{ producto.descripcion }}</p>
                        <p style="margin-top: 10px;"><strong>Stock disponible:</strong>
                            <span
                                style="color: {% if producto.cantidadDisponible > 50 %}#2ecc71{% elif producto.cantidadDisponible > 10 %}#f39c12{% else %}#e74c3c{% endif %};">
                                {{ producto.cantidadDisponible }} kg
                            </span>
                        </p>
                    </div>

                    <!-- Selector de Cantidad -->
                    <div class="quantity-selector">
                        <button onclick="decreaseQuantity('{{ producto.id }}')">-</button>
                        <input type="number" id="qty-{{ producto.id }}" value="1" min="1"
                            max="{{ producto.cantidadDisponible }}" step="0.5">
                        <button onclick="increaseQuantity('{{ producto.id }}')">+</button>
                        <span style="font-size: 0.9em; color: #666;">kg</span>
                    </div>

                    <button class="add-to-cart-btn"
                        onclick="addToCart('{{ producto.id }}', '{{ producto.nombre }}', {{ producto.precio }}, '{{ producto.imagenUrl }}', {{ producto.cantidadDisponible }})">
                        ðŸ›’ Agregar al Carrito
                    </button>
                </div>
            </div>
            {% else %}
            <div style="grid-column: 1/-1; text-align: center; padding: 50px; color: #999;">
                <h3>No hay productos disponibles en este momento.</h3>
                <p>Vuelve mÃ¡s tarde para ver las novedades.</p>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Modal del Carrito -->
    <div class="cart-modal" id="cartModal">
        <div class="cart-content">
            <h2>ðŸ›’ Mi Carrito de Compras</h2>
            <div id="cart-items"></div>
            <div class="cart-total">
                Total: $<span id="cart-total">0.00</span>
            </div>
            <button class="checkout-btn" onclick="checkout()">Finalizar Compra</button>
            <button class="checkout-btn" style="background: #95a5a6; margin-top: 10px;" onclick="toggleCart()">Continuar
                Comprando</button>
        </div>
    </div>

    <script>
        let cart = [];

        function increaseQuantity(productId) {
            const input = document.getElementById('qty-' + productId);
            const max = parseFloat(input.max);
            const current = parseFloat(input.value);
            if (current < max) {
                input.value = (current + 0.5).toFixed(1);
            }
        }

        function decreaseQuantity(productId) {
            const input = document.getElementById('qty-' + productId);
            const current = parseFloat(input.value);
            if (current > 1) {
                input.value = (current - 0.5).toFixed(1);
            }
        }

        function addToCart(productId, productName, price, imageUrl, maxStock) {
            const quantity = parseFloat(document.getElementById('qty-' + productId).value);

            // Verificar si el producto ya estÃ¡ en el carrito
            const existingItem = cart.find(item => item.id === productId);

            if (existingItem) {
                const newQuantity = existingItem.quantity + quantity;
                if (newQuantity <= maxStock) {
                    existingItem.quantity = newQuantity;
                } else {
                    alert('No hay suficiente stock disponible');
                    return;
                }
            } else {
                cart.push({
                    id: productId,
                    name: productName,
                    price: price,
                    quantity: quantity,
                    imageUrl: imageUrl
                });
            }

            updateCartDisplay();

            // Mostrar mensaje de confirmaciÃ³n
            alert(`âœ“ ${quantity} kg de ${productName} agregado al carrito`);
        }

        function removeFromCart(productId) {
            cart = cart.filter(item => item.id !== productId);
            updateCartDisplay();
        }

        function updateCartDisplay() {
            // Actualizar contador
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('cart-count').textContent = totalItems.toFixed(1);

            // Actualizar lista de items
            const cartItemsDiv = document.getElementById('cart-items');
            if (cart.length === 0) {
                cartItemsDiv.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Tu carrito estÃ¡ vacÃ­o</p>';
            } else {
                cartItemsDiv.innerHTML = cart.map(item => `
                    <div class="cart-item">
                        <img src="${item.imageUrl || 'https://via.placeholder.com/60'}" class="cart-item-image" alt="${item.name}">
                        <div class="cart-item-details">
                            <strong>${item.name}</strong><br>
                            <span style="color: #2ecc71;">$${item.price} x ${item.quantity} kg</span><br>
                            <strong>Subtotal: $${(item.price * item.quantity).toFixed(2)}</strong>
                        </div>
                        <button class="cart-item-remove" onclick="removeFromCart('${item.id}')">âœ•</button>
                    </div>
                `).join('');
            }

            // Actualizar total
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            document.getElementById('cart-total').textContent = total.toFixed(2);
        }

        function toggleCart() {
            const modal = document.getElementById('cartModal');
            modal.classList.toggle('show');
        }

        function checkout() {
            if (cart.length === 0) {
                alert('Tu carrito estÃ¡ vacÃ­o');
                return;
            }

            // Enviar el carrito al servidor
            fetch('/marketplace/checkout', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ items: cart })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Â¡Compra realizada exitosamente!');
                        cart = [];
                        updateCartDisplay();
                        toggleCart();
                        window.location.href = '/pagos';
                    } else {
                        alert('Error al procesar la compra: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al procesar la compra');
                });
        }

        // Cerrar modal al hacer clic fuera
        document.getElementById('cartModal').addEventListener('click', function (e) {
            if (e.target === this) {
                toggleCart();
            }
        });
    </script>
</body>

</html>